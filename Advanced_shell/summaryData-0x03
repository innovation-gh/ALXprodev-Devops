#!/bin/bash

# Summary Data - Task 3
# Creates a CSV report and calculates averages

OUTPUT_DIR="pokemon_data"
CSV_FILE="pokemon_report.csv"

# Check if pokemon_data directory exists
if [[ ! -d "$OUTPUT_DIR" ]]; then
    echo "Error: $OUTPUT_DIR directory not found. Run the batch processing script first."
    exit 1
fi

# Create CSV header
echo "Name,Height (m),Weight (kg)" > "$CSV_FILE"

# Initialize variables for calculating averages
total_height=0
total_weight=0
count=0

echo "CSV Report generated at: $CSV_FILE"
echo ""

# Process each JSON file
for json_file in "$OUTPUT_DIR"/*.json; do
    if [[ -f "$json_file" ]]; then
        # Extract data from JSON
        name=$(jq -r '.name' "$json_file" | sed 's/^./\u&/')  # Capitalize first letter
        height_dm=$(jq -r '.height' "$json_file")
        weight_hg=$(jq -r '.weight' "$json_file")
        
        # Convert units: height from decimeters to meters, weight from hectograms to kg
        height=$(echo "$height_dm" | awk '{printf "%.1f", $1/10}')
        weight=$(echo "$weight_hg" | awk '{printf "%.1f", $1/10}')
        
        # Add to CSV
        echo "$name,$height,$weight" >> "$CSV_FILE"
        
        # Add to totals for average calculation
        total_height=$(echo "$total_height + $height" | bc -l)
        total_weight=$(echo "$total_weight + $weight" | bc -l)
        count=$((count + 1))
    fi
done

# Display the CSV content
cat "$CSV_FILE"
echo ""

# Calculate and display averages using awk
if [[ $count -gt 0 ]]; then
    avg_height=$(echo "$total_height / $count" | bc -l | awk '{printf "%.2f", $1}')
    avg_weight=$(echo "$total_weight / $count" | bc -l | awk '{printf "%.2f", $1}')
    
    echo "Average Height: $avg_height m"
    echo "Average Weight: $avg_weight kg"
else
    echo "No Pokemon data found to calculate averages."
fi